<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDC Sim Admin Panel</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #0a0e1a 0%, #1a1f35 50%, #0a0e1a 100%);
            color: #fff;
            min-height: 100vh;
        }

        /* Login Screen */
        #login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        #login-screen.hidden {
            display: none;
        }

        .login-box {
            background: linear-gradient(145deg, #1a1f35, #0f1525);
            border: 2px solid #ffd700;
            border-radius: 12px;
            padding: 40px;
            max-width: 400px;
            width: 100%;
        }

        .login-box h1 {
            color: #ffd700;
            text-align: center;
            margin-bottom: 30px;
        }

        .login-box input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            background: #0a0e1a;
            border: 1px solid #444;
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
        }

        .login-box button {
            width: 100%;
            padding: 14px;
            background: #ffd700;
            border: none;
            border-radius: 6px;
            color: #000;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
        }

        .login-box button:hover {
            background: #ffed4a;
        }

        .login-error {
            color: #ff4444;
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
        }

        /* Admin Panel */
        #admin-panel {
            display: none;
        }

        #admin-panel.active {
            display: block;
        }

        .header {
            background: linear-gradient(90deg, #0a0e1a, #1a1f35);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #ffd700;
        }

        .header h1 {
            color: #ffd700;
            font-size: 24px;
        }

        .header button {
            padding: 10px 20px;
            background: #9a0000;
            border: none;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
            font-weight: bold;
        }

        .main-content {
            display: flex;
            min-height: calc(100vh - 70px);
        }

        .sidebar {
            width: 250px;
            background: #0f1525;
            padding: 20px;
            border-right: 1px solid #333;
        }

        .sidebar button {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            background: transparent;
            border: 1px solid #444;
            border-radius: 6px;
            color: #ccc;
            cursor: pointer;
            text-align: left;
            font-size: 14px;
        }

        .sidebar button:hover {
            background: #1a1f35;
            border-color: #ffd700;
        }

        .sidebar button.active {
            background: #ffd700;
            color: #000;
            border-color: #ffd700;
        }

        .content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .content h2 {
            color: #ffd700;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }

        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #333;
            font-size: 13px;
        }

        .data-table th {
            background: #1a1f35;
            color: #ffd700;
            font-weight: bold;
        }

        .data-table tr:hover {
            background: rgba(255, 215, 0, 0.05);
        }

        .btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin-right: 3px;
        }

        .btn-edit {
            background: #0066cc;
            color: #fff;
        }

        .btn-delete {
            background: #9a0000;
            color: #fff;
        }

        .btn-add {
            background: #00b359;
            color: #fff;
            padding: 10px 20px;
            font-size: 14px;
        }

        .btn-import {
            background: #6600cc;
            color: #fff;
            padding: 10px 20px;
            font-size: 14px;
        }

        .btn-clear {
            background: #cc6600;
            color: #fff;
            padding: 10px 20px;
            font-size: 14px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(145deg, #1a1f35, #0f1525);
            border: 2px solid #ffd700;
            border-radius: 12px;
            padding: 30px;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-content h3 {
            color: #ffd700;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            color: #aaa;
            font-size: 11px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px;
            background: #0a0e1a;
            border: 1px solid #444;
            border-radius: 4px;
            color: #fff;
            font-size: 13px;
        }

        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-save {
            background: #00b359;
            color: #fff;
        }

        .btn-cancel {
            background: #444;
            color: #fff;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(145deg, #1a1f35, #0f1525);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
            color: #ffd700;
        }

        .stat-card .label {
            color: #888;
            font-size: 13px;
            margin-top: 5px;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .toolbar-left {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-bar input {
            width: 250px;
            padding: 10px;
            background: #0a0e1a;
            border: 1px solid #444;
            border-radius: 4px;
            color: #fff;
        }

        .status-badge {
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
        }

        .status-yes {
            background: #00b359;
        }

        .status-no {
            background: #666;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: rgba(0, 179, 89, 0.2);
            border: 1px solid #00b359;
        }

        .alert-error {
            background: rgba(255, 68, 68, 0.2);
            border: 1px solid #ff4444;
        }

        .alert-info {
            background: rgba(0, 102, 204, 0.2);
            border: 1px solid #0066cc;
        }

        /* Mobile menu toggle */
        .menu-toggle {
            display: none;
            background: transparent;
            border: 1px solid #ffd700;
            color: #ffd700;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {

            .data-table th,
            .data-table td {
                padding: 8px 4px;
                font-size: 12px;
            }

            .modal-content {
                max-width: 95%;
                padding: 20px;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 12px 15px;
                flex-wrap: wrap;
                gap: 10px;
            }

            .header h1 {
                font-size: 18px;
                flex: 1;
            }

            .menu-toggle {
                display: block;
                order: -1;
            }

            .header button:not(.menu-toggle) {
                padding: 8px 15px;
                font-size: 13px;
            }

            .main-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                padding: 10px;
                border-right: none;
                border-bottom: 1px solid #333;
                display: none;
                position: absolute;
                top: 60px;
                left: 0;
                right: 0;
                z-index: 100;
                background: #0f1525;
            }

            .sidebar.open {
                display: block;
            }

            .sidebar button {
                padding: 12px;
                font-size: 14px;
            }

            .content {
                padding: 15px;
                margin-top: 0;
            }

            .content h2 {
                font-size: 20px;
            }

            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .toolbar-left {
                flex-direction: column;
            }

            .search-bar input {
                width: 100%;
            }

            .toolbar>div:last-child {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
            }

            .toolbar>div:last-child .btn {
                flex: 1;
                min-width: 120px;
            }

            /* Responsive table */
            .data-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }

            .data-table th,
            .data-table td {
                min-width: 80px;
            }

            .form-row {
                flex-direction: column;
                gap: 0;
            }

            .modal-content {
                max-height: 90vh;
                margin: 10px;
                width: calc(100% - 20px);
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-card .number {
                font-size: 24px;
            }

            .btn {
                padding: 8px 12px;
                font-size: 12px;
            }

            .btn-add,
            .btn-import,
            .btn-clear {
                padding: 10px 15px;
                font-size: 13px;
            }
        }

        @media (max-width: 480px) {
            .login-box {
                padding: 25px 20px;
            }

            .login-box h1 {
                font-size: 22px;
            }

            .header h1 {
                font-size: 16px;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .modal-content {
                padding: 15px;
            }

            .modal-content h3 {
                font-size: 18px;
            }

            .modal-content h4 {
                font-size: 13px;
            }

            .form-group label {
                font-size: 10px;
            }

            .form-group input,
            .form-group select {
                padding: 10px 8px;
                font-size: 14px;
            }

            .modal-buttons {
                flex-direction: column;
            }

            .modal-buttons button {
                padding: 14px;
            }

            #rounds-container,
            #prizes-container {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            /* Table card view for very small screens */
            .data-table thead {
                display: none;
            }

            .data-table,
            .data-table tbody,
            .data-table tr,
            .data-table td {
                display: block;
                width: 100%;
            }

            .data-table tr {
                margin-bottom: 15px;
                background: #1a1f35;
                border-radius: 8px;
                padding: 10px;
                border: 1px solid #333;
            }

            .data-table td {
                text-align: left;
                padding: 8px 10px;
                border: none;
                position: relative;
                padding-left: 45%;
                white-space: normal;
                min-width: unset;
            }

            .data-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 10px;
                width: 40%;
                font-weight: bold;
                color: #ffd700;
                font-size: 11px;
            }

            .data-table td:last-child {
                padding-left: 10px;
                text-align: center;
            }

            .data-table td:last-child::before {
                display: none;
            }
        }
    </style>
</head>

<body>
    <!-- Login Screen -->
    <div id="login-screen">
        <div class="login-box">
            <h1>üîê Admin Login</h1>
            <input type="text" id="admin-username" placeholder="Username">
            <input type="password" id="admin-password" placeholder="Password">
            <button onclick="adminLogin()">LOGIN</button>
            <div id="login-error" class="login-error"></div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel">
        <div class="header">
            <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
            <h1>‚öôÔ∏è PDC Sim Admin Panel</h1>
            <button onclick="adminLogout()">üö™ Logout</button>
        </div>

        <div class="main-content">
            <div class="sidebar" id="sidebar">
                <button class="active" onclick="showSection('dashboard', this)">üìä Dashboard</button>
                <button onclick="showSection('tournaments', this)">üèÜ Tournaments</button>
                <button onclick="showSection('players', this)">üë§ Players</button>
                <button onclick="showSection('themes', this)">üé® Themes</button>
                <button onclick="showSection('users', this)">üë• Users</button>
                <button onclick="showSection('import', this)">üì• Import Data</button>
            </div>

            <div class="content">
                <!-- Dashboard -->
                <div id="section-dashboard" class="section">
                    <h2>Dashboard</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="number" id="stat-tournaments">0</div>
                            <div class="label">Tournaments</div>
                        </div>
                        <div class="stat-card">
                            <div class="number" id="stat-players">0</div>
                            <div class="label">Players</div>
                        </div>
                        <div class="stat-card">
                            <div class="number" id="stat-themes">0</div>
                            <div class="label">Custom Themes</div>
                        </div>
                        <div class="stat-card">
                            <div class="number" id="stat-users">0</div>
                            <div class="label">Registered Users</div>
                        </div>
                        <div class="stat-card">
                            <div class="number" id="stat-saves">0</div>
                            <div class="label">Cloud Saves</div>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <strong>üìã Setup Info:</strong> After git pull on server, access the admin panel at
                        <code>/admin.html</code>.
                        If database is empty, use the <strong>Import Data</strong> section to load the default
                        tournaments and players.
                    </div>
                </div>

                <!-- Tournaments -->
                <div id="section-tournaments" class="section" style="display:none;">
                    <h2>Tournament Management</h2>
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <div class="search-bar">
                                <input type="text" id="tournament-search" placeholder="Search tournaments..."
                                    oninput="filterTournaments()">
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-add" onclick="openTournamentModal()">+ Add Tournament</button>
                        </div>
                    </div>
                    <div id="tournaments-loading" class="loading">Loading tournaments...</div>
                    <table class="data-table" id="tournaments-table" style="display:none;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Date</th>
                                <th>Format</th>
                                <th>Players</th>
                                <th>Type</th>
                                <th>Card</th>
                                <th>Theme</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tournaments-tbody"></tbody>
                    </table>
                </div>

                <!-- Players -->
                <div id="section-players" class="section" style="display:none;">
                    <h2>Player Management</h2>
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <div class="search-bar">
                                <input type="text" id="player-search" placeholder="Search players..."
                                    oninput="filterPlayers()">
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-add" onclick="openPlayerModal()">+ Add Player</button>
                        </div>
                    </div>
                    <div id="players-loading" class="loading">Loading players...</div>
                    <table class="data-table" id="players-table" style="display:none;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Country</th>
                                <th>Avg</th>
                                <th>CO%</th>
                                <th>Fav</th>
                                <th>Money</th>
                                <th>Tour Card</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="players-tbody"></tbody>
                    </table>
                </div>

                <!-- Users -->
                <div id="section-users" class="section" style="display:none;">
                    <h2>User Management</h2>
                    <div id="users-loading" class="loading">Loading users...</div>
                    <table class="data-table" id="users-table" style="display:none;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Created</th>
                                <th>Last Sync</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-tbody"></tbody>
                    </table>
                </div>

                <!-- Themes -->
                <div id="section-themes" class="section" style="display:none;">
                    <h2>Theme Customization</h2>
                    <div class="alert alert-info">
                        <strong>üé® Theme Editor:</strong> Customize colors and appearance for each tournament type.
                        Changes are saved to the database and will override the default themes.
                    </div>
                    <div class="toolbar">
                        <div class="toolbar-left">
                            <div class="search-bar">
                                <input type="text" id="theme-search" placeholder="Search themes..."
                                    oninput="filterThemes()">
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-add" onclick="openThemeModal()">+ Add Custom Theme</button>
                        </div>
                    </div>
                    <div id="themes-loading" class="loading">Loading themes...</div>
                    <div id="themes-grid"
                        style="display: none; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin-top: 20px;">
                    </div>
                </div>

                <!-- Import Data -->
                <div id="section-import" class="section" style="display:none;">
                    <h2>Import Default Data</h2>
                    <div class="alert alert-info">
                        <strong>üìã Instructions:</strong> Use these buttons to import the default tournaments and
                        players from the game.
                        This is useful for initial setup or resetting the database to defaults.
                    </div>
                    <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 20px;">
                        <div class="stat-card" style="flex: 1; min-width: 250px;">
                            <h3 style="color: #ffd700; margin-bottom: 15px;">üèÜ Tournaments</h3>
                            <p style="color: #888; margin-bottom: 15px;">Import tournaments from JSON file</p>
                            <input type="file" id="tournaments-file" accept=".json" style="display: none;"
                                onchange="importTournamentsFromFile(this)">
                            <button class="btn btn-import" onclick="document.getElementById('tournaments-file').click()"
                                style="width: 100%;">üìÅ Upload JSON File</button>
                            <button class="btn btn-clear" onclick="clearTournaments()"
                                style="width: 100%; margin-top: 10px;">Clear All</button>
                        </div>
                        <div class="stat-card" style="flex: 1; min-width: 250px;">
                            <h3 style="color: #ffd700; margin-bottom: 15px;">üë§ Players</h3>
                            <p style="color: #888; margin-bottom: 15px;">Import players from JSON file</p>
                            <input type="file" id="players-file" accept=".json" style="display: none;"
                                onchange="importPlayersFromFile(this)">
                            <button class="btn btn-import" onclick="document.getElementById('players-file').click()"
                                style="width: 100%;">üìÅ Upload JSON File</button>
                            <button class="btn" onclick="deduplicatePlayers()"
                                style="width: 100%; margin-top: 10px; background: #2196F3;">üîÑ Remove
                                Duplicates</button>
                            <button class="btn btn-clear" onclick="clearPlayers()"
                                style="width: 100%; margin-top: 10px;">Clear All</button>
                        </div>
                    </div>
                    <div id="import-status" style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tournament Modal -->
    <div id="tournament-modal" class="modal">
        <div class="modal-content" style="max-width: 850px;">
            <h3 id="tournament-modal-title">Add Tournament</h3>
            <input type="hidden" id="edit-tournament-id">

            <!-- Basic Info -->
            <h4
                style="color: #ffd700; margin: 15px 0 10px; font-size: 14px; border-bottom: 1px solid #333; padding-bottom: 5px;">
                üìã Basic Info</h4>
            <div class="form-row">
                <div class="form-group">
                    <label>Tournament ID</label>
                    <input type="number" id="edit-tourn-id" placeholder="Unique ID">
                </div>
                <div class="form-group">
                    <label>Tournament Name</label>
                    <input type="text" id="edit-tourn-name" placeholder="e.g., WORLD CHAMPIONSHIP">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Date</label>
                    <input type="text" id="edit-tourn-date" placeholder="e.g., Dec 15">
                </div>
                <div class="form-group">
                    <label>Players Count</label>
                    <input type="number" id="edit-tourn-players" placeholder="e.g., 32">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Format</label>
                    <select id="edit-tourn-format">
                        <option value="legs">Legs</option>
                        <option value="sets">Sets</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Type</label>
                    <select id="edit-tourn-type" onchange="onTypeChange()">
                        <option value="players">Players Championship</option>
                        <option value="minor">European Tour</option>
                        <option value="major">Major</option>
                        <option value="premier-league">Premier League</option>
                        <option value="premier-league-playoff">PL Playoff</option>
                        <option value="world">World Championship</option>
                        <option value="grandprix">Grand Prix</option>
                        <option value="masters">Masters</option>
                        <option value="masters-final">Masters Final</option>
                        <option value="matchplay">World Matchplay</option>
                        <option value="uk-open">UK Open</option>
                        <option value="challenge">Challenge Tour</option>
                        <option value="q-school">Q-School</option>
                        <option value="et-qual-tc">ET Qualifier (TC)</option>
                        <option value="et-host-nation">ET Host Nation</option>
                        <option value="et-east-european">ET East European</option>
                        <option value="et-nordic-baltic">ET Nordic Baltic</option>
                        <option value="wc-qual-intl">WC Intl Qualifier</option>
                        <option value="wc-qual-tc">WC TC Qualifier</option>
                        <option value="ws-qual-tc">World Series Qual</option>
                        <option value="gs-qual-tc">Grand Slam Qual</option>
                        <option value="wmasters-qual">W Masters Qual</option>
                        <option value="winmaudm">Winmau Masters</option>
                        <option value="grandslam">Grand Slam</option>
                        <option value="europeanf">European Final</option>
                        <option value="playersf">Players Final</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Tour Card Required</label>
                    <select id="edit-tourn-cardRequired">
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Location (optional)</label>
                    <input type="text" id="edit-tourn-location" placeholder="e.g., uk, eu">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Region (optional)</label>
                    <input type="text" id="edit-tourn-region" placeholder="e.g., asia, europe">
                </div>
                <div class="form-group">
                    <label>Night (PL only)</label>
                    <input type="number" id="edit-tourn-night" placeholder="e.g., 1-16">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Target Event ID (qualifiers)</label>
                    <input type="number" id="edit-tourn-targetEvent" placeholder="Target tournament ID">
                </div>
                <div class="form-group">
                    <label>Qualification Slots</label>
                    <input type="number" id="edit-tourn-slots" placeholder="e.g., 8">
                </div>
            </div>

            <!-- Appearance -->
            <h4
                style="color: #ffd700; margin: 20px 0 10px; font-size: 14px; border-bottom: 1px solid #333; padding-bottom: 5px;">
                üé® Appearance</h4>
            <div class="form-row">
                <div class="form-group">
                    <label>Theme Preset</label>
                    <select id="edit-tourn-theme-select">
                        <option value="">-- Use Type Default --</option>
                        <!-- Populated dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label>Logo (optional override)</label>
                    <input type="file" id="edit-tourn-logo-upload" accept="image/*" style="margin-bottom: 6px;"
                        onchange="handleLogoUpload(event)">
                    <input type="text" id="edit-tourn-logo" placeholder="Leave empty to use theme logo">
                    <div id="logo-preview-container" style="display:none; margin-top:4px;">
                        <img id="logo-preview-img" src="" alt="Logo Preview"
                            style="max-width:80px; max-height:40px; border:1px solid #333; border-radius:4px; background:#222;">
                    </div>
                </div>
            </div>

            <!-- Round Format -->
            <h4
                style="color: #ffd700; margin: 20px 0 10px; font-size: 14px; border-bottom: 1px solid #333; padding-bottom: 5px;">
                üéØ Round Format (Legs/Sets per Round)</h4>
            <div id="rounds-container"
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px;">
                <!-- Dynamically populated -->
            </div>
            <button type="button" onclick="addRoundField()" class="btn" style="margin-top: 10px; background: #444;">+
                Add Round</button>

            <!-- Prize Money -->
            <h4
                style="color: #ffd700; margin: 20px 0 10px; font-size: 14px; border-bottom: 1px solid #333; padding-bottom: 5px;">
                üí∞ Prize Money Structure</h4>
            <div id="prizes-container"
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px;">
                <!-- Dynamically populated -->
            </div>
            <button type="button" onclick="addPrizeField()" class="btn" style="margin-top: 10px; background: #444;">+
                Add Prize Level</button>

            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeTournamentModal()">Cancel</button>
                <button class="btn-save" onclick="saveTournament()">Save</button>
            </div>
        </div>
    </div>

    <!-- Player Modal -->
    <div id="player-modal" class="modal">
        <div class="modal-content">
            <h3 id="player-modal-title">Add Player</h3>
            <input type="hidden" id="edit-player-id">
            <div class="form-row">
                <div class="form-group">
                    <label>Player Name</label>
                    <input type="text" id="edit-player-name" placeholder="e.g., Luke Littler">
                </div>
                <div class="form-group">
                    <label>Country Code</label>
                    <input type="text" id="edit-player-country" placeholder="e.g., eng, nl, ger">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Average</label>
                    <input type="number" step="0.01" id="edit-player-avg" placeholder="e.g., 95.5">
                </div>
                <div class="form-group">
                    <label>Checkout %</label>
                    <input type="number" step="0.1" id="edit-player-co" placeholder="e.g., 40.0">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Favourite Double</label>
                    <input type="number" id="edit-player-fav" placeholder="e.g., 20, 16, 18">
                </div>
                <div class="form-group">
                    <label>Prize Money</label>
                    <input type="number" id="edit-player-money" placeholder="e.g., 500000">
                </div>
            </div>
            <div class="form-group">
                <label>Tour Card</label>
                <select id="edit-player-tourCard">
                    <option value="true">Yes</option>
                    <option value="false">No</option>
                </select>
            </div>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closePlayerModal()">Cancel</button>
                <button class="btn-save" onclick="savePlayer()">Save</button>
            </div>
        </div>
    </div>

    <!-- Theme Modal -->
    <div id="theme-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <h3 id="theme-modal-title">Edit Theme</h3>
            <input type="hidden" id="edit-theme-original-id">

            <div class="form-group">
                <label>Theme ID (e.g., matchplay, world, premier-league)</label>
                <input type="text" id="edit-theme-id" placeholder="Unique theme identifier">
            </div>

            <h4
                style="color: #ffd700; margin: 15px 0 10px; font-size: 14px; border-bottom: 1px solid #333; padding-bottom: 5px;">
                üé® Colors</h4>
            <div class="form-row">
                <div class="form-group">
                    <label>Primary Color (Color 1)</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="color" id="edit-theme-color1" value="#000000"
                            style="width: 60px; height: 35px; padding: 0; border: none; cursor: pointer;">
                        <input type="text" id="edit-theme-color1-text" placeholder="#000000" style="flex: 1;"
                            oninput="document.getElementById('edit-theme-color1').value = this.value; updateThemePreview();">
                    </div>
                </div>
                <div class="form-group">
                    <label>Secondary Color (Color 2)</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="color" id="edit-theme-color2" value="#333333"
                            style="width: 60px; height: 35px; padding: 0; border: none; cursor: pointer;">
                        <input type="text" id="edit-theme-color2-text" placeholder="#333333" style="flex: 1;"
                            oninput="document.getElementById('edit-theme-color2').value = this.value; updateThemePreview();">
                    </div>
                </div>
            </div>

            <!-- Preview -->
            <div class="form-group">
                <label>Preview</label>
                <div id="theme-preview"
                    style="height: 60px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); border: 1px solid #444;">
                    THEME PREVIEW
                </div>
            </div>

            <h4
                style="color: #ffd700; margin: 15px 0 10px; font-size: 14px; border-bottom: 1px solid #333; padding-bottom: 5px;">
                üñºÔ∏è Logo & CSS</h4>
            <div class="form-row">
                <div class="form-group">
                    <label>Logo Filename</label>
                    <input type="text" id="edit-theme-logo" placeholder="e.g., worldchampionship.png">
                </div>
                <div class="form-group">
                    <label>CSS Theme Class</label>
                    <input type="text" id="edit-theme-class" placeholder="e.g., theme-world-championship">
                </div>
            </div>

            <h4
                style="color: #ffd700; margin: 15px 0 10px; font-size: 14px; border-bottom: 1px solid #333; padding-bottom: 5px;">
                ‚ö° Active Player Gradient</h4>
            <div class="form-row">
                <div class="form-group">
                    <label>Active Gradient Start</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="color" id="edit-theme-ag1" value="#333333"
                            style="width: 60px; height: 35px; padding: 0; border: none; cursor: pointer;">
                        <input type="text" id="edit-theme-ag1-text" placeholder="#333333" style="flex: 1;"
                            oninput="document.getElementById('edit-theme-ag1').value = this.value;">
                    </div>
                </div>
                <div class="form-group">
                    <label>Active Gradient End</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="color" id="edit-theme-ag2" value="#111111"
                            style="width: 60px; height: 35px; padding: 0; border: none; cursor: pointer;">
                        <input type="text" id="edit-theme-ag2-text" placeholder="#111111" style="flex: 1;"
                            oninput="document.getElementById('edit-theme-ag2').value = this.value;">
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>Leg Name Color</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="color" id="edit-theme-legcolor" value="#ffffff"
                        style="width: 60px; height: 35px; padding: 0; border: none; cursor: pointer;">
                    <input type="text" id="edit-theme-legcolor-text" placeholder="white or #ffffff" style="flex: 1;"
                        oninput="document.getElementById('edit-theme-legcolor').value = this.value;">
                </div>
            </div>

            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeThemeModal()">Cancel</button>
                <button class="btn btn-delete" onclick="resetThemeToDefault()" id="btn-reset-theme"
                    style="display:none;">Reset to Default</button>
                <button class="btn-save" onclick="saveTheme()">Save Theme</button>
            </div>
        </div>
    </div>

    <script>
        // Logo upload handler
        async function handleLogoUpload(event) {
            const fileInput = event.target;
            const file = fileInput.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append('logo', file);
            // Show uploading state
            fileInput.disabled = true;
            try {
                const resp = await fetch('/api/upload_logo.php', {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();
                if (data.success && data.filename) {
                    document.getElementById('edit-tourn-logo').value = data.filename;
                    // Show preview
                    const preview = document.getElementById('logo-preview-img');
                    preview.src = '/logos/' + data.filename;
                    document.getElementById('logo-preview-container').style.display = 'block';
                } else {
                    alert('Upload failed: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Upload failed: ' + e.message);
            }
            fileInput.disabled = false;
        }
        const API_BASE = '/api';
        let tournaments = [];
        let players = [];
        let themes = [];
        let isLoggedIn = false;

        // Admin credentials
        const ADMIN_USER = 'root';
        const ADMIN_PASS = 'admin';

        // ==================== AUTH ====================

        function adminLogin() {
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;

            if (username === ADMIN_USER && password === ADMIN_PASS) {
                isLoggedIn = true;
                localStorage.setItem('admin_logged_in', 'true');
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-panel').classList.add('active');
                loadDashboard();
            } else {
                document.getElementById('login-error').innerText = 'Invalid credentials';
            }
        }

        function adminLogout() {
            isLoggedIn = false;
            localStorage.removeItem('admin_logged_in');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('admin-panel').classList.remove('active');
        }

        function showSection(section, btn) {
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            document.querySelectorAll('.sidebar button').forEach(b => b.classList.remove('active'));
            document.getElementById('section-' + section).style.display = 'block';
            if (btn) btn.classList.add('active');

            // Close sidebar on mobile after selection
            const sidebar = document.getElementById('sidebar');
            if (sidebar && window.innerWidth <= 768) {
                sidebar.classList.remove('open');
            }

            if (section === 'tournaments') loadTournaments();
            if (section === 'players') loadPlayers();
            if (section === 'users') loadUsers();
            if (section === 'themes') loadThemes();
            if (section === 'dashboard') loadDashboard();
        }

        // Toggle sidebar for mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        // ==================== DASHBOARD ====================

        async function loadDashboard() {
            try {
                const stats = await fetch(API_BASE + '/admin/stats').then(r => r.json());
                document.getElementById('stat-tournaments').innerText = stats.tournaments || 0;
                document.getElementById('stat-players').innerText = stats.players || 0;
                document.getElementById('stat-themes').innerText = stats.themes || 0;
                document.getElementById('stat-users').innerText = stats.users || 0;
                document.getElementById('stat-saves').innerText = stats.saves || 0;
            } catch (e) {
                console.log('Stats not available:', e);
            }
        }

        // ==================== DEFAULT DATA FROM DARTS.HTML ====================

        // Default colors and logos based on tournament type/name
        const DEFAULT_APPEARANCE = {
            'matchplay': { color1: '#8B0000', color2: '#B22222', logo: 'worldmatchplay.png', theme: 'theme-matchplay' },
            'uk-open': { color1: '#C8102E', color2: '#FFD100', logo: 'ukopen.png', theme: 'theme-uk-open' },
            'playersf': { color1: '#111111', color2: '#C8102E', logo: 'playersc.png', theme: 'theme-players-championship' },
            'grandslam': { color1: '#FF8C00', color2: '#111111', logo: 'mrvegas.png', theme: 'theme-grand-slam' },
            'masters-final': { color1: '#7A0000', color2: '#000000', logo: 'worldseriesofdarts.png', theme: 'theme-world-series' },
            'grandprix': { color1: '#0033A0', color2: '#00AEEF', logo: 'grandprix.png', theme: 'theme-world-grandprix' },
            'winmaudm': { color1: '#000000', color2: '#FFFFFF', logo: 'worldmasters.png', theme: 'theme-winmau' },
            'europeanf': { color1: '#5B2D8B', color2: '#C0C0C0', logo: 'europeanchampionship.png', theme: 'theme-european' },
            'world': { color1: '#0C3B2E', color2: '#1E7F43', logo: 'worldchampionship.png', theme: 'theme-world-championship' },
            'players': { color1: '#111111', color2: '#C8102E', logo: 'playersc.png', theme: 'theme-players-championship' },
            'premier-league': { color1: '#0A1AFF', color2: '#001B5E', logo: 'premierleague.png', theme: 'theme-premier-league' },
            'premier-league-playoff': { color1: '#0A1AFF', color2: '#001B5E', logo: 'premierleague.png', theme: 'theme-premier-league' },
            'masters': { color1: '#000000', color2: '#D4AF37', logo: 'worldseries.png', theme: 'theme-masters' },
            'minor': { color1: '#1A1A1A', color2: '#2E2E2E', logo: '', theme: 'theme-minor' },
            'challenge': { color1: '#1A1A1A', color2: '#2E2E2E', logo: '', theme: 'theme-minor' },
            'q-school': { color1: '#1A1A1A', color2: '#2E2E2E', logo: '', theme: 'theme-minor' },
            'et-qual-tc': { color1: '#1A1A1A', color2: '#2E2E2E', logo: '', theme: 'theme-minor' },
            'et-host-nation': { color1: '#1A1A1A', color2: '#2E2E2E', logo: '', theme: 'theme-minor' },
            'et-east-european': { color1: '#1A1A1A', color2: '#2E2E2E', logo: '', theme: 'theme-minor' },
            'et-nordic-baltic': { color1: '#1A1A1A', color2: '#2E2E2E', logo: '', theme: 'theme-minor' },
            'ws-qual-tc': { color1: '#7A0000', color2: '#000000', logo: 'worldseries.png', theme: 'theme-world-series' },
            'gs-qual-tc': { color1: '#FF8C00', color2: '#111111', logo: 'mrvegas.png', theme: 'theme-grand-slam' },
            'wmasters-qual': { color1: '#000000', color2: '#FFFFFF', logo: 'worldmasters.png', theme: 'theme-winmau' }
        };

        // Default round formats (legs to win) based on tournament type
        const DEFAULT_ROUND_FORMATS = {
            'masters': { L16: 6, QF: 6, SF: 8, F: 8 },
            'major': { QF: 10, SF: 10, F: 11 },
            'minor': { L32: 6, L16: 6, QF: 6, SF: 7, F: 8 },
            'matchplay': { L32: 10, L16: 11, QF: 16, SF: 17, F: 18 },
            'masters-final': { L32: 6, L16: 6, QF: 10, SF: 11, F: 11 },
            'grandprix': { L32: 2, L16: 3, QF: 3, SF: 5, F: 6 },
            'europeanf': { L32: 6, L16: 6, QF: 10, SF: 11, F: 11 },
            'players': { L128: 6, L64: 6, L32: 6, L16: 6, QF: 6, SF: 7, F: 8 },
            'challenge': { L128: 5, L64: 5, L32: 5, L16: 5, QF: 5, SF: 6, F: 6 },
            'grandslam': { Group: 5, L16: 10, QF: 16, SF: 16, F: 16 },
            'playersf': { L64: 6, L32: 6, L16: 10, QF: 10, SF: 11, F: 11 },
            'q-school': { L256: 5, L128: 5, L64: 5, L32: 5, L16: 5, QF: 5, SF: 6, F: 6 },
            'world': { L128: 3, L64: 3, L32: 4, L16: 4, QF: 5, SF: 6, F: 7 },
            'uk-open': { L128: 6, L64: 6, L32: 6, L16: 10, QF: 10, SF: 11, F: 11 },
            'et-qual-tc': { L64: 6, L32: 6, L16: 6, QF: 6, SF: 7, F: 8 },
            'et-host-nation': { QF: 6, SF: 7, F: 8 },
            'et-east-european': { L16: 6, QF: 6, SF: 7, F: 8 },
            'et-nordic-baltic': { L16: 6, QF: 6, SF: 7, F: 8 },
            'ws-qual-tc': { L64: 6, L32: 6, L16: 6, QF: 6, SF: 7, F: 8 },
            'gs-qual-tc': { L64: 6, L32: 6, L16: 6, QF: 6, SF: 7, F: 8 },
            'wmasters-qual': { L64: 6, L32: 6, L16: 6, QF: 6, SF: 7, F: 8 },
            'winmaudm': { L32: 2, L16: 4, QF: 4, SF: 5, F: 6 },
            'premier-league': { R1: 6, SF: 10, F: 11 },
            'premier-league-playoff': { SF: 11, F: 11 }
        };

        // Default prize money structure based on tournament type
        const DEFAULT_PRIZE_STRUCTURE = {
            'masters': { 16: 1000, 8: 3000, 4: 5000, 2: 8000, 1: 12000 },
            'masters-final': { 32: 5000, 16: 10000, 8: 17500, 4: 30000, 2: 60000, 1: 100000 },
            'q-school': { 128: 0, 64: 0, 32: 0, 16: 0, 8: 0, 4: 0, 2: 0, 1: 0 },
            'minor': { 32: 2500, 16: 4000, 8: 6000, 4: 8500, 2: 12000, 1: 30000 },
            'major': { 64: 2500, 32: 5000, 16: 10000, 8: 20000, 4: 40000, 2: 80000, 1: 150000 },
            'world': { 128: 15000, 64: 25000, 32: 35000, 16: 60000, 8: 100000, 4: 200000, 2: 400000, 1: 1000000 },
            'players': { 64: 1000, 32: 2000, 16: 3000, 8: 5000, 4: 7500, 2: 10000, 1: 15000 },
            'challenge': { 64: 100, 32: 250, 16: 350, 8: 750, 4: 1000, 2: 2000, 1: 3000 },
            'uk-open': { 128: 1000, 64: 2500, 32: 5000, 16: 10000, 8: 15000, 4: 30000, 2: 50000, 1: 110000 },
            'et-qual-tc': { 64: 0, 32: 0, 16: 0, 8: 0, 4: 0, 2: 0, 1: 0 },
            'et-host-nation': { 8: 0, 4: 0, 2: 0, 1: 0 },
            'et-east-european': { 16: 0, 8: 0, 4: 0, 2: 0, 1: 0 },
            'et-nordic-baltic': { 16: 0, 8: 0, 4: 0, 2: 0, 1: 0 },
            'ws-qual-tc': { 64: 0, 32: 0, 16: 0, 8: 0, 4: 0, 2: 0, 1: 0 },
            'gs-qual-tc': { 64: 0, 32: 0, 16: 0, 8: 0, 4: 0, 2: 0, 1: 0 },
            'wmasters-qual': { 64: 0, 32: 0, 16: 0, 8: 0, 4: 0, 2: 0, 1: 0 },
            'winmaudm': { 32: 5000, 16: 10000, 8: 17500, 4: 30000, 2: 50000, 1: 100000 },
            'matchplay': { 32: 10000, 16: 15000, 8: 30000, 4: 50000, 2: 100000, 1: 200000 },
            'europeanf': { 32: 7500, 16: 15000, 8: 25000, 4: 40000, 2: 60000, 1: 120000 },
            'grandprix': { 32: 7500, 16: 15000, 8: 25000, 4: 40000, 2: 60000, 1: 120000 },
            'playersf': { 64: 3000, 32: 6500, 16: 10000, 8: 20000, 4: 30000, 2: 60000, 1: 120000 },
            'grandslam': { 32: 5000, 16: 12250, 8: 25000, 4: 50000, 2: 70000, 1: 150000 },
            'premier-league': { 8: 0, 4: 5000, 2: 10000, 1: 25000 },
            'premier-league-playoff': { 4: 50000, 2: 100000, 1: 275000 }
        };

        // ==================== TOURNAMENTS ====================

        async function loadTournaments() {
            document.getElementById('tournaments-loading').style.display = 'block';
            document.getElementById('tournaments-table').style.display = 'none';

            try {
                const result = await fetch(API_BASE + '/admin/tournaments').then(r => r.json());
                if (result.success) {
                    tournaments = result.tournaments;
                    renderTournaments();
                }
            } catch (e) {
                console.error('Failed to load tournaments:', e);
                document.getElementById('tournaments-loading').innerText = 'Failed to load tournaments';
            }
        }

        function renderTournaments(data = null) {
            const list = data || tournaments;
            document.getElementById('tournaments-loading').style.display = 'none';
            document.getElementById('tournaments-table').style.display = 'table';

            const tbody = document.getElementById('tournaments-tbody');
            tbody.innerHTML = list.map(t => {
                const themeName = t.themePreset || `(${t.type})`;
                return `
                <tr>
                    <td data-label="ID">${t.id}</td>
                    <td data-label="Name">${t.name}</td>
                    <td data-label="Date">${t.date}</td>
                    <td data-label="Format"><span style="color:${t.format === 'sets' ? '#ffd700' : '#00b359'}">${t.format.toUpperCase()}</span></td>
                    <td data-label="Players">${t.players}</td>
                    <td data-label="Type">${t.type}</td>
                    <td data-label="Card"><span class="status-badge ${t.cardRequired ? 'status-yes' : 'status-no'}">${t.cardRequired ? 'YES' : 'NO'}</span></td>
                    <td data-label="Theme"><span style="color: ${t.themePreset ? '#ffd700' : '#888'}; font-size: 11px;">${themeName}</span></td>
                    <td data-label="Actions">
                        <button class="btn btn-edit" onclick="editTournament(${t.id})">Edit</button>
                        <button class="btn btn-delete" onclick="deleteTournament(${t.id})">Del</button>
                    </td>
                </tr>
            `}).join('');
        }

        function filterTournaments() {
            const search = document.getElementById('tournament-search').value.toLowerCase();
            const filtered = tournaments.filter(t =>
                t.name.toLowerCase().includes(search) ||
                t.type.toLowerCase().includes(search) ||
                String(t.id).includes(search)
            );
            renderTournaments(filtered);
        }

        async function openTournamentModal(tournament = null) {
            document.getElementById('tournament-modal-title').innerText = tournament ? 'Edit Tournament' : 'Add Tournament';
            document.getElementById('edit-tournament-id').value = tournament ? tournament.id : '';
            document.getElementById('edit-tourn-id').value = tournament ? tournament.id : '';
            document.getElementById('edit-tourn-name').value = tournament ? tournament.name : '';
            document.getElementById('edit-tourn-date').value = tournament ? tournament.date : '';
            document.getElementById('edit-tourn-players').value = tournament ? tournament.players : '';
            document.getElementById('edit-tourn-format').value = tournament ? tournament.format : 'legs';
            document.getElementById('edit-tourn-type').value = tournament ? tournament.type : 'players';
            document.getElementById('edit-tourn-cardRequired').value = tournament ? String(tournament.cardRequired) : 'false';
            document.getElementById('edit-tourn-location').value = tournament ? (tournament.location || '') : '';
            document.getElementById('edit-tourn-region').value = tournament ? (tournament.region || '') : '';
            document.getElementById('edit-tourn-night').value = tournament ? (tournament.night || '') : '';
            document.getElementById('edit-tourn-targetEvent').value = tournament ? (tournament.targetEvent || '') : '';
            document.getElementById('edit-tourn-slots').value = tournament ? (tournament.slots || '') : '';


            // Get type for defaults
            const tType = tournament?.type || 'players';
            const defaultAppearance = DEFAULT_APPEARANCE[tType] || DEFAULT_APPEARANCE['minor'];

            // Logo - use tournament's custom logo or leave blank to use theme default
            document.getElementById('edit-tourn-logo').value = (tournament && typeof tournament.logo === 'string') ? tournament.logo : '';
            document.getElementById('edit-tourn-logo').placeholder = `Theme default: ${defaultAppearance.logo || 'none'}`;

            // Rounds format - use tournament values or defaults from type
            const roundsContainer = document.getElementById('rounds-container');
            roundsContainer.innerHTML = '';
            if (tournament?.rounds && Array.isArray(tournament.rounds) && tournament.rounds.length > 0) {
                tournament.rounds.forEach((r, idx) => {
                    addRoundField(r.name || `R${idx + 1}`, r.target || 5);
                });
            } else {
                // Use defaults based on tournament type
                const defaultRounds = DEFAULT_ROUND_FORMATS[tType] || DEFAULT_ROUND_FORMATS['minor'];
                if (defaultRounds) {
                    // Convert object format to array
                    Object.entries(defaultRounds).forEach(([name, target]) => {
                        addRoundField(name, target);
                    });
                } else {
                    // Fallback to generic defaults
                    const genericRounds = getDefaultRounds(tournament?.players || 32, tournament?.format || 'legs');
                    genericRounds.forEach(r => addRoundField(r.name, r.target));
                }
            }

            // Prize money - use tournament values or defaults from type
            const prizesContainer = document.getElementById('prizes-container');
            prizesContainer.innerHTML = '';
            if (tournament?.prizes && typeof tournament.prizes === 'object' && Object.keys(tournament.prizes).length > 0) {
                Object.entries(tournament.prizes).sort((a, b) => parseInt(b[0]) - parseInt(a[0])).forEach(([pos, amount]) => {
                    addPrizeField(pos, amount);
                });
            } else {
                // Use defaults based on tournament type
                const defaultPrizes = DEFAULT_PRIZE_STRUCTURE[tType] || DEFAULT_PRIZE_STRUCTURE['minor'];
                if (defaultPrizes) {
                    Object.entries(defaultPrizes).sort((a, b) => parseInt(b[0]) - parseInt(a[0])).forEach(([pos, amount]) => {
                        addPrizeField(pos, amount);
                    });
                } else {
                    // Fallback
                    addPrizeField('1', 15000);
                    addPrizeField('2', 10000);
                    addPrizeField('4', 7500);
                    addPrizeField('8', 5000);
                }
            }

            // Populate theme dropdown and select current value
            await populateThemeDropdown();
            const selectedTheme = tournament?.themePreset || '';
            document.getElementById('edit-tourn-theme-select').value = selectedTheme;

            document.getElementById('tournament-modal').classList.add('active');
        }

        // Populate theme dropdown with available themes
        async function populateThemeDropdown() {
            const select = document.getElementById('edit-tourn-theme-select');

            // Keep the first default option
            select.innerHTML = '<option value="">-- Use Type Default --</option>';

            // Try to load themes if not already loaded
            if (!themes || themes.length === 0) {
                try {
                    const result = await fetch(API_BASE + '/admin/themes').then(r => r.json());
                    if (result.success) {
                        themes = result.themes;
                    }
                } catch (e) {
                    console.log('Could not load themes for dropdown');
                }
            }

            // Add themes to dropdown
            themes.forEach(t => {
                const option = document.createElement('option');
                option.value = t.id;
                option.textContent = t.id + (t.isCustom ? ' ‚ú®' : '');
                select.appendChild(option);
            });
        }

        // Update defaults when type changes
        function onTypeChange() {
            const tType = document.getElementById('edit-tourn-type').value;
            const defaultAppearance = DEFAULT_APPEARANCE[tType] || DEFAULT_APPEARANCE['minor'];

            // Reset theme dropdown to default (use type default)
            document.getElementById('edit-tourn-theme-select').value = '';

            // Clear logo override
            document.getElementById('edit-tourn-logo').value = '';
            document.getElementById('edit-tourn-logo').placeholder = `Type default: ${defaultAppearance.logo || 'none'}`;

            // Update rounds
            const roundsContainer = document.getElementById('rounds-container');
            roundsContainer.innerHTML = '';
            const defaultRounds = DEFAULT_ROUND_FORMATS[tType] || DEFAULT_ROUND_FORMATS['minor'];
            if (defaultRounds) {
                Object.entries(defaultRounds).forEach(([name, target]) => {
                    addRoundField(name, target);
                });
            }

            // Update prizes
            const prizesContainer = document.getElementById('prizes-container');
            prizesContainer.innerHTML = '';
            const defaultPrizes = DEFAULT_PRIZE_STRUCTURE[tType] || DEFAULT_PRIZE_STRUCTURE['minor'];
            if (defaultPrizes) {
                Object.entries(defaultPrizes).sort((a, b) => parseInt(b[0]) - parseInt(a[0])).forEach(([pos, amount]) => {
                    addPrizeField(pos, amount);
                });
            }
        }

        function getDefaultRounds(playerCount, format) {
            const rounds = [];
            const roundNames = { 128: 'L128', 64: 'L64', 32: 'L32', 16: 'L16', 8: 'QF', 4: 'SF', 2: 'F' };
            let current = playerCount;
            while (current >= 2) {
                const name = roundNames[current] || `L${current}`;
                const target = format === 'sets' ? (current <= 4 ? 5 : 3) : (current <= 4 ? 7 : 5);
                rounds.push({ name, target });
                current = Math.floor(current / 2);
            }
            return rounds;
        }

        function addRoundField(name = '', target = 5) {
            const container = document.getElementById('rounds-container');
            const idx = container.children.length;
            const div = document.createElement('div');
            div.className = 'form-group';
            div.style.cssText = 'margin-bottom: 0;';
            div.innerHTML = `
                <label style="font-size: 10px;">${name || 'Round ' + (idx + 1)}</label>
                <div style="display: flex; gap: 4px;">
                    <input type="text" class="round-name" value="${name}" placeholder="Name" style="width: 50px; font-size: 11px; padding: 4px;">
                    <input type="number" class="round-target" value="${target}" placeholder="Target" style="width: 50px; font-size: 11px; padding: 4px;">
                    <button type="button" onclick="this.parentElement.parentElement.remove()" style="padding: 4px 8px; background: #9a0000; border: none; color: #fff; border-radius: 3px; cursor: pointer;">√ó</button>
                </div>
            `;
            container.appendChild(div);
        }

        function addPrizeField(position = '', amount = 0) {
            const container = document.getElementById('prizes-container');
            const div = document.createElement('div');
            div.className = 'form-group';
            div.style.cssText = 'margin-bottom: 0;';
            const posLabel = position == '1' ? 'Winner' : position == '2' ? 'R-Up' : position == '4' ? 'SF' : position == '8' ? 'QF' : `Top ${position}`;
            div.innerHTML = `
                <label style="font-size: 10px;">${posLabel}</label>
                <div style="display: flex; gap: 4px;">
                    <input type="number" class="prize-pos" value="${position}" placeholder="Pos" style="width: 45px; font-size: 11px; padding: 4px;">
                    <input type="number" class="prize-amount" value="${amount}" placeholder="¬£" style="width: 70px; font-size: 11px; padding: 4px;">
                    <button type="button" onclick="this.parentElement.parentElement.remove()" style="padding: 4px 8px; background: #9a0000; border: none; color: #fff; border-radius: 3px; cursor: pointer;">√ó</button>
                </div>
            `;
            container.appendChild(div);
        }

        function closeTournamentModal() {
            document.getElementById('tournament-modal').classList.remove('active');
        }

        function editTournament(id) {
            const tournament = tournaments.find(t => t.id === id);
            if (tournament) openTournamentModal(tournament);
        }

        async function saveTournament() {
            // Collect rounds
            const rounds = [];
            document.querySelectorAll('#rounds-container .form-group').forEach(div => {
                const name = div.querySelector('.round-name').value;
                const target = parseInt(div.querySelector('.round-target').value) || 5;
                if (name) rounds.push({ name, target });
            });

            // Collect prizes
            const prizes = {};
            document.querySelectorAll('#prizes-container .form-group').forEach(div => {
                const pos = div.querySelector('.prize-pos').value;
                const amount = parseInt(div.querySelector('.prize-amount').value) || 0;
                if (pos) prizes[pos] = amount;
            });

            const tournament = {
                id: parseInt(document.getElementById('edit-tourn-id').value),
                name: document.getElementById('edit-tourn-name').value,
                date: document.getElementById('edit-tourn-date').value,
                players: parseInt(document.getElementById('edit-tourn-players').value),
                format: document.getElementById('edit-tourn-format').value,
                type: document.getElementById('edit-tourn-type').value,
                cardRequired: document.getElementById('edit-tourn-cardRequired').value === 'true',
                location: document.getElementById('edit-tourn-location').value || null,
                region: document.getElementById('edit-tourn-region').value || null,
                night: document.getElementById('edit-tourn-night').value ? parseInt(document.getElementById('edit-tourn-night').value) : null,
                targetEvent: document.getElementById('edit-tourn-targetEvent').value ? parseInt(document.getElementById('edit-tourn-targetEvent').value) : null,
                slots: document.getElementById('edit-tourn-slots').value ? parseInt(document.getElementById('edit-tourn-slots').value) : null,
                // Appearance - only save themePreset and optional logo override
                themePreset: document.getElementById('edit-tourn-theme-select').value || null,
                logo: document.getElementById('edit-tourn-logo').value || null,
                // Rounds and prizes
                rounds: rounds.length > 0 ? rounds : null,
                prizes: Object.keys(prizes).length > 0 ? prizes : null
            };

            const editId = document.getElementById('edit-tournament-id').value;

            try {
                if (editId) {
                    await fetch(API_BASE + '/admin/tournaments/' + editId, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(tournament)
                    });
                } else {
                    await fetch(API_BASE + '/admin/tournaments', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(tournament)
                    });
                }
                loadTournaments();
                closeTournamentModal();
            } catch (e) {
                alert('Failed to save tournament: ' + e.message);
            }
        }

        async function deleteTournament(id) {
            if (!confirm('Delete this tournament?')) return;

            try {
                await fetch(API_BASE + '/admin/tournaments/' + id, { method: 'DELETE' });
                loadTournaments();
            } catch (e) {
                alert('Failed to delete tournament');
            }
        }

        // ==================== PLAYERS ====================

        async function loadPlayers() {
            document.getElementById('players-loading').style.display = 'block';
            document.getElementById('players-table').style.display = 'none';

            try {
                const result = await fetch(API_BASE + '/admin/players').then(r => r.json());
                if (result.success) {
                    players = result.players;
                    renderPlayers();
                }
            } catch (e) {
                console.error('Failed to load players:', e);
                document.getElementById('players-loading').innerText = 'Failed to load players';
            }
        }

        function renderPlayers(data = null) {
            const list = data || players;
            document.getElementById('players-loading').style.display = 'none';
            document.getElementById('players-table').style.display = 'table';

            const tbody = document.getElementById('players-tbody');
            tbody.innerHTML = list.map(p => `
                <tr>
                    <td data-label="ID">${p.id}</td>
                    <td data-label="Name">${p.name}</td>
                    <td data-label="Country">${p.country.toUpperCase()}</td>
                    <td data-label="Average">${p.avg.toFixed(2)}</td>
                    <td data-label="CO%">${p.co.toFixed(1)}%</td>
                    <td data-label="Fav">D${p.fav}</td>
                    <td data-label="Money">¬£${p.money.toLocaleString()}</td>
                    <td data-label="Card"><span class="status-badge ${p.tourCard ? 'status-yes' : 'status-no'}">${p.tourCard ? 'YES' : 'NO'}</span></td>
                    <td data-label="Actions">
                        <button class="btn btn-edit" onclick="editPlayer(${p.id})">Edit</button>
                        <button class="btn btn-delete" onclick="deletePlayer(${p.id})">Del</button>
                    </td>
                </tr>
            `).join('');
        }

        function filterPlayers() {
            const search = document.getElementById('player-search').value.toLowerCase();
            const filtered = players.filter(p =>
                p.name.toLowerCase().includes(search) ||
                p.country.toLowerCase().includes(search)
            );
            renderPlayers(filtered);
        }

        function openPlayerModal(player = null) {
            document.getElementById('player-modal-title').innerText = player ? 'Edit Player' : 'Add Player';
            document.getElementById('edit-player-id').value = player ? player.id : '';
            document.getElementById('edit-player-name').value = player ? player.name : '';
            document.getElementById('edit-player-country').value = player ? player.country : '';
            document.getElementById('edit-player-avg').value = player ? player.avg : '85.0';
            document.getElementById('edit-player-co').value = player ? player.co : '35.0';
            document.getElementById('edit-player-fav').value = player ? player.fav : '20';
            document.getElementById('edit-player-money').value = player ? player.money : '0';
            document.getElementById('edit-player-tourCard').value = player ? String(player.tourCard) : 'false';
            document.getElementById('player-modal').classList.add('active');
        }

        function closePlayerModal() {
            document.getElementById('player-modal').classList.remove('active');
        }

        function editPlayer(id) {
            const player = players.find(p => p.id === id);
            if (player) openPlayerModal(player);
        }

        async function savePlayer() {
            const player = {
                name: document.getElementById('edit-player-name').value,
                country: document.getElementById('edit-player-country').value.toLowerCase(),
                avg: parseFloat(document.getElementById('edit-player-avg').value) || 85.0,
                co: parseFloat(document.getElementById('edit-player-co').value) || 35.0,
                fav: parseInt(document.getElementById('edit-player-fav').value) || 20,
                money: parseInt(document.getElementById('edit-player-money').value) || 0,
                tourCard: document.getElementById('edit-player-tourCard').value === 'true'
            };

            const editId = document.getElementById('edit-player-id').value;

            try {
                if (editId) {
                    await fetch(API_BASE + '/admin/players/' + editId, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(player)
                    });
                } else {
                    await fetch(API_BASE + '/admin/players', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(player)
                    });
                }
                loadPlayers();
                closePlayerModal();
            } catch (e) {
                alert('Failed to save player: ' + e.message);
            }
        }

        async function deletePlayer(id) {
            if (!confirm('Delete this player?')) return;

            try {
                await fetch(API_BASE + '/admin/players/' + id, { method: 'DELETE' });
                loadPlayers();
            } catch (e) {
                alert('Failed to delete player');
            }
        }

        // ==================== THEMES ====================

        async function loadThemes() {
            document.getElementById('themes-loading').style.display = 'block';
            document.getElementById('themes-grid').style.display = 'none';

            try {
                const result = await fetch(API_BASE + '/admin/themes').then(r => r.json());
                if (result.success) {
                    themes = result.themes;
                    renderThemes();
                }
            } catch (e) {
                console.error('Failed to load themes:', e);
                document.getElementById('themes-loading').innerText = 'Failed to load themes';
            }
        }

        function renderThemes(data = null) {
            const list = data || themes;
            document.getElementById('themes-loading').style.display = 'none';
            document.getElementById('themes-grid').style.display = 'grid';

            const grid = document.getElementById('themes-grid');
            grid.innerHTML = list.map(t => {
                const gradientStyle = `background: linear-gradient(135deg, ${t.color1} 0%, ${t.color2} 100%);`;
                const customBadge = t.isCustom ? '<span style="background:#00b359; color:#fff; padding:2px 6px; border-radius:3px; font-size:10px; margin-left:5px;">CUSTOM</span>' : '';
                const defaultBadge = t.isDefault ? '' : '<span style="background:#ff9800; color:#fff; padding:2px 6px; border-radius:3px; font-size:10px; margin-left:5px;">NEW</span>';

                const deleteBtn = t.isDefault
                    ? `<button class="btn btn-delete" onclick="resetTheme('${t.id}')" title="Reset to default" style="flex: 0 0 35px;">‚Ü∫</button>`
                    : `<button class="btn btn-delete" onclick="deleteTheme('${t.id}')" title="Delete theme" style="flex: 0 0 35px;">Del</button>`;

                return `
                <div style="background: linear-gradient(145deg, #1a1f35, #0f1525); border: 1px solid #333; border-radius: 8px; overflow: hidden;">
                    <div style="${gradientStyle} height: 60px; display: flex; align-items: center; justify-content: center;">
                        ${t.logo ? `<img src="/logos/${t.logo}" style="height: 40px; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.5));" onerror="this.style.display='none'">` : ''}
                    </div>
                    <div style="padding: 12px;">
                        <div style="font-weight: bold; color: #ffd700; margin-bottom: 5px;">
                            ${t.id}${customBadge}${defaultBadge}
                        </div>
                        <div style="font-size: 11px; color: #888; margin-bottom: 8px;">
                            ${t.color1} ‚Üí ${t.color2}
                        </div>
                        <div style="font-size: 10px; color: #666; margin-bottom: 10px;">
                            CSS: ${t.theme || 'none'}
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn btn-edit" onclick="editTheme('${t.id}')" style="flex:1;">Edit</button>
                            ${deleteBtn}
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function filterThemes() {
            const search = document.getElementById('theme-search').value.toLowerCase();
            const filtered = themes.filter(t =>
                t.id.toLowerCase().includes(search) ||
                (t.theme && t.theme.toLowerCase().includes(search))
            );
            renderThemes(filtered);
        }

        function openThemeModal(theme = null) {
            document.getElementById('theme-modal-title').innerText = theme ? 'Edit Theme' : 'Add Custom Theme';
            document.getElementById('edit-theme-original-id').value = theme ? theme.id : '';
            document.getElementById('edit-theme-id').value = theme ? theme.id : '';
            document.getElementById('edit-theme-id').disabled = theme && theme.isDefault;

            // Colors
            const c1 = theme ? theme.color1 : '#1a1a1a';
            const c2 = theme ? theme.color2 : '#2e2e2e';
            document.getElementById('edit-theme-color1').value = c1;
            document.getElementById('edit-theme-color1-text').value = c1;
            document.getElementById('edit-theme-color2').value = c2;
            document.getElementById('edit-theme-color2-text').value = c2;

            // Logo and CSS
            document.getElementById('edit-theme-logo').value = theme ? (theme.logo || '') : '';
            document.getElementById('edit-theme-class').value = theme ? (theme.theme || '') : '';

            // Active gradient
            const ag1 = theme ? (theme.activeGradient1 || c2) : '#333333';
            const ag2 = theme ? (theme.activeGradient2 || c1) : '#111111';
            document.getElementById('edit-theme-ag1').value = ag1;
            document.getElementById('edit-theme-ag1-text').value = ag1;
            document.getElementById('edit-theme-ag2').value = ag2;
            document.getElementById('edit-theme-ag2-text').value = ag2;

            // Leg name color
            const legColor = theme ? (theme.legNameColor || 'white') : 'white';
            const legColorHex = legColor === 'white' ? '#ffffff' : (legColor === '#000' ? '#000000' : legColor);
            document.getElementById('edit-theme-legcolor').value = legColorHex;
            document.getElementById('edit-theme-legcolor-text').value = legColor;

            // Show/hide delete/reset button in modal
            const btnReset = document.getElementById('btn-reset-theme');
            if (theme) {
                btnReset.style.display = 'inline-block';
                btnReset.innerText = theme.isDefault ? 'Reset to Default' : 'Delete Theme';
                btnReset.style.background = '#9a0000';
            } else {
                btnReset.style.display = 'none';
            }

            updateThemePreview();
            document.getElementById('theme-modal').classList.add('active');

            // Sync color pickers
            document.getElementById('edit-theme-color1').addEventListener('input', function () {
                document.getElementById('edit-theme-color1-text').value = this.value;
                updateThemePreview();
            });
            document.getElementById('edit-theme-color2').addEventListener('input', function () {
                document.getElementById('edit-theme-color2-text').value = this.value;
                updateThemePreview();
            });
            document.getElementById('edit-theme-ag1').addEventListener('input', function () {
                document.getElementById('edit-theme-ag1-text').value = this.value;
            });
            document.getElementById('edit-theme-ag2').addEventListener('input', function () {
                document.getElementById('edit-theme-ag2-text').value = this.value;
            });
            document.getElementById('edit-theme-legcolor').addEventListener('input', function () {
                document.getElementById('edit-theme-legcolor-text').value = this.value;
            });
        }

        function updateThemePreview() {
            const c1 = document.getElementById('edit-theme-color1').value;
            const c2 = document.getElementById('edit-theme-color2').value;
            const preview = document.getElementById('theme-preview');
            preview.style.background = `linear-gradient(135deg, ${c1} 0%, ${c2} 100%)`;
            // Determine text color based on brightness
            const brightness = (parseInt(c1.slice(1, 3), 16) + parseInt(c2.slice(1, 3), 16)) / 2;
            preview.style.color = brightness < 128 ? '#fff' : '#000';
        }

        function closeThemeModal() {
            document.getElementById('theme-modal').classList.remove('active');
        }

        function editTheme(id) {
            const theme = themes.find(t => t.id === id);
            if (theme) openThemeModal(theme);
        }

        async function saveTheme() {
            const themeData = {
                id: document.getElementById('edit-theme-id').value.trim(),
                color1: document.getElementById('edit-theme-color1').value,
                color2: document.getElementById('edit-theme-color2').value,
                logo: document.getElementById('edit-theme-logo').value.trim(),
                theme: document.getElementById('edit-theme-class').value.trim(),
                activeGradient1: document.getElementById('edit-theme-ag1').value,
                activeGradient2: document.getElementById('edit-theme-ag2').value,
                legNameColor: document.getElementById('edit-theme-legcolor-text').value.trim() || 'white'
            };

            if (!themeData.id) {
                alert('Theme ID is required');
                return;
            }

            try {
                const response = await fetch(API_BASE + '/admin/themes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(themeData)
                });
                const result = await response.json();

                if (result.success) {
                    loadThemes();
                    closeThemeModal();
                } else {
                    alert('Failed to save theme: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Failed to save theme: ' + e.message);
            }
        }

        async function deleteTheme(id) {
            if (!confirm(`Permanently delete "${id}" theme?`)) return;
            try {
                const response = await fetch(API_BASE + '/admin/themes/' + encodeURIComponent(id), { method: 'DELETE' });
                const result = await response.json();
                if (result.success) {
                    loadThemes();
                } else {
                    alert('Failed to delete theme: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Failed to delete theme');
            }
        }

        async function resetTheme(id) {
            if (!confirm(`Reset "${id}" theme to default values?`)) return;

            try {
                const response = await fetch(API_BASE + '/admin/themes/' + encodeURIComponent(id), { method: 'DELETE' });
                const result = await response.json();
                if (result.success) {
                    loadThemes();
                } else {
                    alert('Failed to reset theme: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Failed to reset theme');
            }
        }

        function resetThemeToDefault() {
            const id = document.getElementById('edit-theme-original-id').value;
            if (!id) return;

            const theme = themes.find(t => t.id === id);
            if (!theme) return;

            closeThemeModal();
            if (theme.isDefault) {
                resetTheme(id);
            } else {
                deleteTheme(id);
            }
        }

        // ==================== USERS ====================

        async function loadUsers() {
            document.getElementById('users-loading').style.display = 'block';
            document.getElementById('users-table').style.display = 'none';

            try {
                const result = await fetch(API_BASE + '/admin/users').then(r => r.json());
                if (result.success) {
                    document.getElementById('users-loading').style.display = 'none';
                    document.getElementById('users-table').style.display = 'table';

                    const tbody = document.getElementById('users-tbody');
                    tbody.innerHTML = result.users.map(u => `
                        <tr>
                            <td data-label="ID">${u.id}</td>
                            <td data-label="Username">${u.username}</td>
                            <td data-label="Created">${new Date(u.created_at * 1000).toLocaleDateString()}</td>
                            <td data-label="Last Sync">${u.last_sync ? new Date(u.last_sync * 1000).toLocaleString() : 'Never'}</td>
                            <td data-label="Actions">
                                <button class="btn btn-delete" onclick="deleteUser(${u.id})">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (e) {
                document.getElementById('users-loading').innerText = 'Failed to load users';
            }
        }

        async function deleteUser(id) {
            if (!confirm('Delete this user and their save data?')) return;
            try {
                await fetch(API_BASE + '/admin/users/' + id, { method: 'DELETE' });
                loadUsers();
            } catch (e) {
                alert('Failed to delete user');
            }
        }

        // ==================== IMPORT ====================

        async function importTournamentsFromFile(input) {
            const status = document.getElementById('import-status');
            const file = input.files[0];
            if (!file) return;

            status.innerHTML = '<div class="alert alert-info">Importing tournaments... Please wait.</div>';

            try {
                const text = await file.text();
                const tournaments = JSON.parse(text);

                if (!Array.isArray(tournaments)) throw new Error('JSON must be an array of tournaments');

                // Import in batches of 20 to avoid max_input_vars limit
                const batchSize = 20;
                let imported = 0;

                for (let i = 0; i < tournaments.length; i += batchSize) {
                    const batch = tournaments.slice(i, i + batchSize);
                    status.innerHTML = `<div class="alert alert-info">Importing tournaments... ${i}/${tournaments.length}</div>`;

                    const response = await fetch(API_BASE + '/admin/tournaments/import', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ tournaments: batch })
                    });

                    const responseText = await response.text();
                    console.log('API Response:', response.status, responseText);

                    if (!response.ok) throw new Error(`HTTP ${response.status}: ${responseText}`);
                    if (!responseText) throw new Error('Empty response from server');

                    const result = JSON.parse(responseText);
                    if (!result.success) throw new Error(result.error || 'Import failed');
                    imported += result.imported;
                }

                status.innerHTML = `<div class="alert alert-success">Successfully imported ${imported} tournaments!</div>`;
                loadDashboard();
            } catch (e) {
                status.innerHTML = `<div class="alert alert-error">Failed to import tournaments: ${e.message}</div>`;
                console.error('Import error:', e);
            }
            input.value = ''; // Reset file input
        }

        async function importPlayersFromFile(input) {
            const status = document.getElementById('import-status');
            const file = input.files[0];
            if (!file) return;

            status.innerHTML = '<div class="alert alert-info">Importing players... Please wait.</div>';

            try {
                const text = await file.text();
                const players = JSON.parse(text);

                if (!Array.isArray(players)) throw new Error('JSON must be an array of players');

                // Import in batches of 20 to avoid max_input_vars limit
                const batchSize = 20;
                let imported = 0;

                for (let i = 0; i < players.length; i += batchSize) {
                    const batch = players.slice(i, i + batchSize);
                    status.innerHTML = `<div class="alert alert-info">Importing players... ${i}/${players.length}</div>`;

                    const response = await fetch(API_BASE + '/admin/players/import', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ players: batch })
                    });

                    const responseText = await response.text();
                    console.log('API Response:', response.status, responseText);

                    if (!response.ok) throw new Error(`HTTP ${response.status}: ${responseText}`);
                    if (!responseText) throw new Error('Empty response from server');

                    const result = JSON.parse(responseText);
                    if (!result.success) throw new Error(result.error || 'Import failed');
                    imported += result.imported;
                }

                status.innerHTML = `<div class="alert alert-success">Successfully imported ${imported} players!</div>`;
                loadDashboard();
            } catch (e) {
                status.innerHTML = `<div class="alert alert-error">Failed to import players: ${e.message}</div>`;
                console.error('Import error:', e);
            }
            input.value = ''; // Reset file input
        }

        async function deduplicatePlayers() {
            const status = document.getElementById('import-status');
            status.innerHTML = '<div class="alert alert-info">Removing duplicates... Please wait.</div>';

            try {
                const response = await fetch(API_BASE + '/admin/players/deduplicate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    status.innerHTML = `<div class="alert alert-success">Removed ${result.removed} duplicate players. ${result.remaining} players remaining.</div>`;
                    loadDashboard();
                } else {
                    throw new Error(result.error || 'Deduplication failed');
                }
            } catch (e) {
                status.innerHTML = `<div class="alert alert-error">Failed to remove duplicates: ${e.message}</div>`;
            }
        }

        async function importDefaultTournaments() {
            const status = document.getElementById('import-status');
            status.innerHTML = '<div class="alert alert-info">Importing tournaments... Please wait.</div>';

            try {
                // Fetch tournaments from JSON file
                const response = await fetch('/tournaments.json');
                if (!response.ok) throw new Error('Could not load tournaments.json');
                const tournaments = await response.json();

                // Import to database
                const result = await fetch(API_BASE + '/admin/tournaments/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tournaments })
                }).then(r => r.json());

                if (result.success) {
                    status.innerHTML = `<div class="alert alert-success">Successfully imported ${result.imported} tournaments!</div>`;
                    loadDashboard();
                } else {
                    throw new Error(result.error || 'Import failed');
                }
            } catch (e) {
                status.innerHTML = `<div class="alert alert-error">Failed to import tournaments: ${e.message}</div>`;
            }
        }

        async function importDefaultPlayers() {
            const status = document.getElementById('import-status');
            status.innerHTML = '<div class="alert alert-info">Importing players... Please wait.</div>';

            try {
                // Fetch players from JSON file
                const response = await fetch('/players.json');
                if (!response.ok) throw new Error('Could not load players.json');
                const players = await response.json();

                // Import to database
                const result = await fetch(API_BASE + '/admin/players/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ players })
                }).then(r => r.json());

                if (result.success) {
                    status.innerHTML = `<div class="alert alert-success">Successfully imported ${result.imported} players!</div>`;
                    loadDashboard();
                } else {
                    throw new Error(result.error || 'Import failed');
                }
            } catch (e) {
                status.innerHTML = `<div class="alert alert-error">Failed to import players: ${e.message}</div>`;
            }
        }

        async function clearTournaments() {
            if (!confirm('Are you sure you want to delete ALL tournaments? This cannot be undone.')) return;

            const status = document.getElementById('import-status');
            try {
                await fetch(API_BASE + '/admin/tournaments/clear', { method: 'DELETE' });
                status.innerHTML = '<div class="alert alert-success">All tournaments cleared!</div>';
                loadDashboard();
            } catch (e) {
                status.innerHTML = '<div class="alert alert-error">Failed to clear tournaments</div>';
            }
        }

        async function clearPlayers() {
            if (!confirm('Are you sure you want to delete ALL players? This cannot be undone.')) return;

            const status = document.getElementById('import-status');
            try {
                await fetch(API_BASE + '/admin/players/clear', { method: 'DELETE' });
                status.innerHTML = '<div class="alert alert-success">All players cleared!</div>';
                loadDashboard();
            } catch (e) {
                status.innerHTML = '<div class="alert alert-error">Failed to clear players</div>';
            }
        }

        // ==================== INIT ====================

        // Check if already logged in
        if (localStorage.getItem('admin_logged_in') === 'true') {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-panel').classList.add('active');
            loadDashboard();
        }

    </script>
</body>

</html>